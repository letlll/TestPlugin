# Advanced Table XT

Advanced Table XT 是一个 Obsidian 插件，用于增强 Markdown 表格功能，包括表格样式、单元格合并、表格 ID 等功能。

## 最新更新：表格 ID 识别增强

### 问题背景

之前版本在处理表格 ID 时存在一些问题，特别是当文档中有多个表格时，可能会出现 ID 识别错误，导致样式应用到错误的表格上。主要问题是：

1. 仅依赖 DOM 结构位置进行表格匹配，容易受到 DOM 渲染顺序变化的影响
2. 缺乏可靠的表格特征提取和匹配机制
3. 表格 ID 注释与实际表格的关联不够稳定

### 解决方案

我们实现了一套全新的表格特征提取和匹配系统：

1. **增强的表格特征提取**
   - 提取多维度特征：表头内容、行列数、首尾行内容
   - 计算内容哈希作为唯一指纹
   - 提取合并单元格模式

2. **表格包装注释**
   - 使用 `<!-- table-begin: ID feature: {...} -->` 和 `<!-- table-end: ID -->` 格式
   - 在注释中包含特征 JSON，便于精确匹配
   - 通过设置选项可启用/禁用包装注释模式

3. **多级匹配算法**
   - ID 直接匹配：优先使用精确 ID 匹配
   - 特征匹配：使用加权相似度计算进行表格特征匹配
   - 位置匹配：作为最后的回退方案

4. **减少 DOM 依赖**
   - 直接从 Markdown 内容提取表格信息
   - 使用特征匹配代替位置匹配
   - 最小化 DOM 交互，仅在应用样式时使用

### 使用建议

1. 启用"使用表格注释夹模式"选项可以获得最可靠的表格 ID 识别
2. 对于已有的表格，建议重新生成 ID 以利用增强的特征提取功能
3. 如果遇到表格 ID 识别问题，可以尝试使用工具栏中的"设置表格 ID"功能

## 其他功能

- 单元格合并：使用 `<` 和 `^` 标记合并单元格
- 表格样式：设置行高、列宽、对齐方式等
- 编辑模式操作：在编辑模式下直接修改表格
- 工具栏：提供丰富的表格编辑功能

## 设置选项

- 启用表格 ID：自动为表格添加 ID 作为 HTML 注释
- 使用表格注释夹模式：在表格前后添加配对的 HTML 注释，提高表格 ID 识别的准确性
- 表格 ID 前缀：生成的表格 ID 前缀
- 启用单元格合并：启用使用 `<` 和 `^` 标记进行单元格合并的功能
- 合并非空单元格时确认：当合并包含内容的单元格时显示确认对话框
- 自动居中合并单元格：自动将合并单元格中的内容居中显示

## 功能特点

- 表格单元格合并（支持水平和垂直合并）
- 表格ID自动生成和管理
- 直观的表格编辑工具栏
- 单元格对齐和样式设置
- 行添加和表格样式应用
- **新增: 表格样式持久化** - 在预览模式下保持表格样式
- **新增: 表格大小调整** - 通过拖拽调整行高和列宽

## 使用方法

### 表格工具栏

表格工具栏在预览模式下点击表格时会自动显示，包含以下功能组：

1. **对齐**
   - 左对齐
   - 居中对齐
   - 右对齐
   - 顶部对齐
   - 垂直居中
   - 底部对齐
   - 全部居中

2. **合并**
   - 合并选中单元格
   - 向右合并
   - 向下合并
   - 拆分单元格

3. **表格**
   - 生成表格ID
   - 添加行
   - 表格样式

### 单元格合并语法

在编辑模式下，您可以使用以下语法来合并单元格：

- `<` - 向左合并（与左侧单元格合并）
- `^` - 向上合并（与上方单元格合并）

示例：

```markdown
| 表头1 | 表头2 | 表头3 |
|------|------|------|
| 内容1 | 内容2 | 内容3 |
| 内容4 | <    | 内容5 |
| 内容6 | ^    | 内容7 |
```

在预览模式下，使用工具栏可以更直观地合并单元格：
1. 选择要合并的单元格（使用Ctrl/Cmd+点击可选择多个单元格）
2. 点击合并按钮

### 表格ID

表格ID功能允许您为表格添加唯一标识符，这对于引用和样式应用非常有用。ID会以HTML注释的形式添加到表格前面：

```markdown
<!-- table-id: tbl-20240711-abc123 -->
| 表头1 | 表头2 |
|------|------|
| 内容1 | 内容2 |
```

可以通过工具栏中的"表格ID"按钮自动生成ID。

### 表格样式持久化

本插件支持表格样式的持久化，这意味着您在预览模式下应用的样式（如对齐方式）将被保存并在下次打开文档时自动应用。

样式持久化的工作原理：

1. 当您在预览模式下对表格应用样式时，样式数据会保存到插件的data.json文件中
2. 样式数据与表格ID关联，确保样式应用到正确的表格
3. 当您切换到预览模式时，插件会自动读取保存的样式并应用到对应的表格
4. 样式应用使用Obsidian的MarkdownRenderChild系统，确保与Obsidian的渲染流程无缝集成

支持的持久化样式包括：
- 单元格文本对齐（左对齐、居中、右对齐）
- 单元格垂直对齐（顶部、中间、底部）
- 列宽和行高设置
- 单元格合并状态

### 表格大小调整

本插件现在支持通过拖拽调整表格的行高和列宽：

1. **调整列宽**：
   - 在预览模式下，将鼠标悬停在列分隔线上，会出现一个可拖拽的句柄
   - 拖拽句柄可以调整列的宽度
   - 调整后的列宽会保存并在下次打开文档时自动应用

2. **调整行高**：
   - 在预览模式下，将鼠标悬停在行分隔线上，会出现一个可拖拽的句柄
   - 拖拽句柄可以调整行的高度
   - 调整后的行高会保存并在下次打开文档时自动应用

3. **使用技巧**：
   - 拖拽时会显示辅助线，帮助您精确调整大小
   - 双击句柄可以重置为自动大小
   - 调整大小的数据会自动保存到与表格ID关联的数据中

### 自定义样式

工具栏提供了几种预设样式：
- 条纹样式 - 为奇数行添加背景色
- 边框样式 - 为所有单元格添加边框

## 设置选项

在插件设置中，您可以配置以下选项：

- 启用单元格合并
- 启用表格ID
- 表格ID前缀
- 自动居中合并单元格
- 启用表格工具栏
- 启用编辑模式下的表格操作
- 启用表格大小调整功能 